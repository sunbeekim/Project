<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header :: header">
    <meta charset="UTF-8">
    <title>영화 검색</title>
</head>
<body>
    <nav th:replace="fragments/header :: nav"></nav>

    <div class="container mt-5">
        <!-- 검색 폼 -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0">영화 검색</h3>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="form-label">국가이름</label>
                            <input type="text" class="form-control" id="nation" placeholder="국가 이름을 입력하세요">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="form-label">시작 연도</label>
                            <input type="number" class="form-control" id="startYear" placeholder="시작 연도">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="form-label">종료 연도</label>
                            <input type="number" class="form-control" id="endYear" placeholder="종료 연도">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="form-label">영화 제목</label>
                            <input type="text" class="form-control" id="title" placeholder="영화 제목을 입력하세요">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="form-label">배우</label>
                            <input type="text" class="form-control" id="actor" placeholder="배우 이름을 입력하세요">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="form-label">감독</label>
                            <input type="text" class="form-control" id="director" placeholder="감독 이름을 입력하세요">
                        </div>
                    </div>
                    <div class="col-12">
                        <button class="btn btn-primary" onclick="handleSearch()">
                            <i class="fas fa-search me-1"></i>검색
                        </button>
                    </div>
                </div>
            </div>
        </div>

        

        <!-- 영화 목록 -->
        <div id="movieList" class="card mb-4" style="display: none;">
            <div class="card-header">
                <h4 class="mb-0">영화 목록</h4>
            </div>
            <div class="card-body">
                <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" id="movieGrid">
                    <!-- JavaScript로 동적 생성됨 -->
                </div>
            </div>
        </div>

        <!-- 로딩 스피너 -->
        <div id="loadingSpinner" class="text-center py-5" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-2">데이터를 불러오는 중...</div>
        </div>

        <!-- 영화 상세 정보 모달 -->
        <div class="modal fade" id="movieDetailModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="movieDetailTitle"></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-4" id="posterContainer">
                                <!-- 포스터 이미지가 여기에 들어갑니다 -->
                            </div>
                            <div class="col-md-8">
                                <div class="card mb-4">
                                    <div class="card-body">
                                        <div class="row mb-3">
                                            <div class="col-md-3 fw-bold">감독</div>
                                            <div class="col-md-9" id="directorInfo">정보없음</div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-md-3 fw-bold">출연</div>
                                            <div class="col-md-9" id="actorInfo">정보없음</div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-md-3 fw-bold">장르</div>
                                            <div class="col-md-9" id="genreInfo">정보없음</div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-md-3 fw-bold">제작년도</div>
                                            <div class="col-md-9" id="yearInfo">정보없음</div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-md-3 fw-bold">상영시간</div>
                                            <div class="col-md-9" id="runtimeInfo">정보없음</div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-md-3 fw-bold">등급</div>
                                            <div class="col-md-9" id="ratingInfo">정보없음</div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-md-3 fw-bold">제작사</div>
                                            <div class="col-md-9" id="companyInfo">정보없음</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">줄거리</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="plotInfo">줄거리 정보가 없습니다.</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer th:replace="fragments/footer :: footer"></footer>

    <script th:inline="javascript">
        
        
        async function handleSearch() {
            showLoading(true);
            
            try {
                const params = new URLSearchParams({
                    ServiceKey: 'KZF0O6JP09Q6O216R86W',
                    collection: 'kmdb_new2',
                    listCount: 500,
                    startCount: 0,
                    detail: 'Y',
                    sort: 'prodYear,1'
                });

                const nation = $('#nation').val();
                const startYear = $('#startYear').val();
                const endYear = $('#endYear').val();
                const title = $('#title').val();
                const actor = $('#actor').val();
                const director = $('#director').val();

                if (nation) params.append('nation', nation);
                if (startYear) params.append('createDts', startYear);
                if (endYear) params.append('createDte', endYear);
                if (title) params.append('title', title);
                if (actor) params.append('actor', actor);
                if (director) params.append('director', director);

                const url = `http://api.koreafilm.or.kr/openapi-data2/wisenut/search_api/search_json2.jsp?${params}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                const movies = data.Data?.[0]?.Result || [];
                displayMovies(movies);
                console.log(movies);
                
            } catch (error) {
                console.error('영화 검색 실패:', error);
                alert('영화 검색에 실패했습니다.');
            } finally {
                showLoading(false);
            }
        }

        function displayMovies(movies) {
            const movieGrid = $('#movieGrid');
            movieGrid.empty();
            
            if (movies.length === 0) {
                movieGrid.html('<p class="text-center w-100">검색 결과가 없습니다.</p>');
                return;
            }

            movies.forEach(movie => {
                const posterUrl = movie.posters?.split('|')[0] || null;
                const stillUrl = movie.stlls?.split('|')[0] || null;
                const imageUrl = posterUrl || stillUrl;
                const directorNames = movie.directors?.director?.map(dir => dir.directorNm).join(', ') || '정보 없음';

                const movieCard = `
                    <div class="col">
                        <div class="card h-100" onclick="showMovieDetail(${JSON.stringify(movie).replace(/"/g, '&quot;')})" style="cursor: pointer">
                            ${imageUrl 
                                ? `<img src="${imageUrl}" class="card-img-top" alt="${movie.title || '영화'}" style="height: 300px; object-fit: cover">` 
                                : `<div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 300px">
                                    <span class="text-muted">이미지가 없습니다</span>
                                   </div>`
                            }
                            <div class="card-body">
                                <h5 class="card-title">${movie.title || '제목 없음'}</h5>
                                <p class="card-text">
                                    <small class="text-muted">
                                        제작 연도: ${movie.prodYear || '알 수 없음'}<br>
                                        감독: ${directorNames}
                                    </small>
                                </p>
                            </div>
                        </div>
                    </div>
                `;
                movieGrid.append(movieCard);
            });

            $('#movieList').show();
        }

        function showMovieDetail(movie) {
            // 모달 제목 설정
            document.getElementById('movieDetailTitle').textContent = movie.title;

            // 포스터 이미지 설정
            const posterContainer = document.getElementById('posterContainer');
            if (movie.posters) {
                const posterUrl = movie.posters.split('|')[0];
                posterContainer.innerHTML = `<img src="${posterUrl}" alt="${movie.title}" class="img-fluid rounded shadow">`;
            } else {
                posterContainer.innerHTML = `<div class="bg-light p-5 text-center rounded"><span class="text-muted">이미지가 없습니다</span></div>`;
            }

            // 영화 정보 설정
            document.getElementById('directorInfo').textContent = movie.directors?.director?.map(d => d.directorNm).join(', ') || '정보없음';
            document.getElementById('actorInfo').textContent = movie.actors?.actor?.map(a => a.actorNm).join(', ') || '정보없음';
            document.getElementById('genreInfo').textContent = movie.genre || '정보없음';
            document.getElementById('yearInfo').textContent = movie.prodYear || '정보없음';
            document.getElementById('runtimeInfo').textContent = movie.runtime ? `${movie.runtime}분` : '정보없음';
            document.getElementById('ratingInfo').textContent = movie.rating || '정보없음';
            document.getElementById('companyInfo').textContent = movie.company || '정보없음';
            document.getElementById('plotInfo').textContent = movie.plots?.plot?.[0]?.plotText || '줄거리 정보가 없습니다.';

            // 모달 표시
            const modal = new bootstrap.Modal(document.getElementById('movieDetailModal'));
            modal.show();
        }

        function showLoading(show) {
            $('#loadingSpinner').toggle(show);
        }
    </script>
</body>
</html>
